#!/bin/sh
set -e

: ${DOMAIN:=$(ip route show | grep default | awk '{print $3}')}
: ${SWANCTL_CONF:="/etc/swanctl/swanctl.conf"}
: ${CA_KEY:="/etc/swanctl/private/ca-key.pem"}
: ${CA_CERT:="/etc/swanctl/x509ca/ca-cert.pem"}
: ${SERVER_KEY:="/etc/swanctl/private/server-key.pem"}
: ${SERVER_CERT:="/etc/swanctl/x509/server-cert.pem"}

if printf "%s" "$DOMAIN" | grep -Eq "^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$"; then
    SANIP="--san @$DOMAIN"
    LEFTID="$DOMAIN"
else
    SANIP=""
    LEFTID="@$DOMAIN"
fi

# Update swanctl.conf with dynamic values
if [ -f "$SWANCTL_CONF" ] && [ -w "$SWANCTL_CONF" ] && ! grep -Fq "$SWANCTL_CONF" /proc/mounts; then
    : ${USERNAME:='username'}
    : ${PASSWORD:='password'}

    D=$(printf "\001")
    CONF_CONTENT=$(cat "$SWANCTL_CONF" | sed "s${D}\$LEFTID${D}$LEFTID${D}g; s${D}\$USERNAME${D}$USERNAME${D}g; s${D}\$PASSWORD${D}$PASSWORD${D}g")

    if [ "$CONF_CONTENT" != "$(cat "$SWANCTL_CONF")" ]; then
        echo "Configuring swanctl.conf with dynamic values..."
        printf "%s\n" "$CONF_CONTENT" > "$SWANCTL_CONF" || true
    fi
fi

# Generate certificates if they don't exist
if [ ! -f "$CA_KEY" ]; then
    echo "Generating CA Key (ECC P-384)..."
    pki --gen --type ecdsa --size 384 --outform pem > "$CA_KEY"
fi

if [ ! -f "$CA_CERT" ]; then
    echo "Generating CA Certificate (ECC)..."
    pki --self --ca --lifetime 3650 --in "$CA_KEY" \
        --type ecdsa --dn "CN=VPN root CA" --outform pem > "$CA_CERT"
fi

if [ ! -f "$SERVER_KEY" ]; then
    echo "Generating Server Key (ECC P-384)..."
    pki --gen --type ecdsa --size 384 --outform pem > "$SERVER_KEY"
fi

if [ ! -f "$SERVER_CERT" ]; then
    echo "Generating Server Certificate (ECC)..."
    pki --pub --in "$SERVER_KEY" --type ecdsa \
        | pki --issue --lifetime 1825 \
        --cacert "$CA_CERT" \
        --cakey "$CA_KEY" \
        --dn "CN=$DOMAIN" --san "$DOMAIN" $SANIP \
        --flag serverAuth --flag ikeIntermediate --outform pem \
        > "$SERVER_CERT"
fi

printf "[CA Certificate Info]\n"
pki --print --in "$SERVER_CERT"
printf "\n[CA Certificate for Client Import]\n"
cat "$CA_CERT"

# Setup iptables if command exists
if command -v setup-firewall > /dev/null 2>&1; then
    setup-firewall
fi

# Start in foreground, but we need to load config after charon is ready
(
    for i in $(seq 1 100); do
        if swanctl --stats > /dev/null 2>&1; then
            echo "Loading swanctl configuration..."
            if swanctl --load-all; then
                exit 0
            else
                kill -TERM 1
                exit 1
            fi
        fi
        sleep 0.2
    done
    echo "Error: Timed out waiting for charon to start!"
    kill -TERM 1
    exit 1
) &

exec ipsec start --nofork
